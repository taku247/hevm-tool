# Hyperevm Chain Tools アーキテクチャ設計書

## 1. システム概要

Hyperevm Chain Toolsは、Hyperevm（HyperLiquid EVM）ブロックチェーンとの相互作用を簡素化するためのツールセットです。Node.jsベースのサーバーサイドスクリプトとWebベースのダッシュボードを提供します。

## 2. アーキテクチャ設計

### 2.1 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Hyperevm Chain Tools                     │
├─────────────────────────────────────────────────────────────┤
│  Frontend (Web Dashboard)                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  HTML/CSS/JavaScript                                   │ │
│  │  - リアルタイム結果表示                                      │ │
│  │  - WebSocket接続管理                                      │ │
│  │  - スクリプト実行UI                                        │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Backend (Express Server)                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  server.js                                             │ │
│  │  - REST API endpoints                                  │ │
│  │  - WebSocket server                                    │ │
│  │  - スクリプト実行制御                                        │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Core Scripts                                               │
│  ┌─────────────────┬─────────────────┬─────────────────────┐ │
│  │ balance_check.js│transaction_     │contract_            │ │
│  │                 │sender.js        │interaction.js       │ │
│  │ - 残高チェック      │ - ETH送金       │ - コントラクト相互作用   │ │
│  │ - 複数アドレス対応   │ - コントラクト     │ - 読み取り/書き込み      │ │
│  │                 │   デプロイ         │ - イベントログ取得       │ │
│  └─────────────────┴─────────────────┴─────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Blockchain Layer                                           │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Hyperevm Network                                      │ │
│  │  RPC: https://rpc.hyperliquid.xyz/evm                 │ │
│  │  Chain ID: 999                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 コンポーネント設計

#### 2.2.1 フロントエンド (index.html)

**責務:**
- ユーザーインターフェースの提供
- スクリプト実行パラメータの入力
- 実行結果のリアルタイム表示
- WebSocket接続状態の管理

**主要機能:**
- スクリプト一覧表示
- パラメータ入力フォーム
- 実行結果の履歴表示
- 接続状態インジケータ

#### 2.2.2 バックエンド (server.js)

**責務:**
- REST APIエンドポイントの提供
- WebSocketサーバーの管理
- スクリプト実行の制御とセキュリティ
- 実行結果のブロードキャスト

**主要エンドポイント:**
- `GET /api/scripts` - 利用可能なスクリプト一覧
- `POST /api/execute-script` - スクリプト実行
- `WebSocket :8080` - リアルタイム通信

#### 2.2.3 コアスクリプト

**HyperevmBalanceChecker (balance_check.js)**
- **責務**: アドレス残高の確認
- **機能**: 単一・複数アドレスの残高チェック
- **出力**: Wei・Ether単位での残高情報

**HyperevmTransactionSender (transaction_sender.js)**
- **責務**: トランザクション送信とコントラクトデプロイ
- **機能**: ETH送金、スマートコントラクトデプロイ
- **セキュリティ**: 秘密鍵の検証

**HyperevmContractInteraction (contract_interaction.js)**
- **責務**: スマートコントラクトとの相互作用
- **機能**: メソッド呼び出し、イベントログ取得
- **対応**: 読み取り専用・書き込み操作

### 2.3 データフロー

```
User Input → Frontend → Backend API → Core Scripts → Blockchain
    ↑                      ↓
    └── WebSocket ←── Results Processing ←── Script Output
```

1. **ユーザー入力**: Webインターフェースでパラメータ入力
2. **API呼び出し**: Express serverのREST APIを呼び出し
3. **スクリプト実行**: 子プロセスでコアスクリプトを実行
4. **ブロックチェーン通信**: ethers.jsを使用してHyperevm RPCと通信
5. **結果返却**: WebSocketでリアルタイム結果をブロードキャスト

## 3. 技術スタック

### 3.1 フロントエンド
- **言語**: HTML5, CSS3, Vanilla JavaScript
- **通信**: WebSocket API, Fetch API
- **スタイル**: CSS Grid, Flexbox, CSS Variables

### 3.2 バックエンド
- **ランタイム**: Node.js
- **フレームワーク**: Express.js
- **WebSocket**: ws library
- **プロセス管理**: child_process

### 3.3 ブロックチェーン
- **ライブラリ**: ethers.js v5.7.2
- **プロトコル**: JSON-RPC over HTTP/WebSocket
- **ネットワーク**: Hyperevm (Chain ID: 999)

## 4. セキュリティ設計

### 4.1 認証・認可
- **スクリプト制限**: 許可リスト方式でスクリプトを制限
- **パラメータ検証**: 入力値の検証とサニタイズ
- **環境変数**: 秘密鍵の外部化

### 4.2 実行制御
- **子プロセス分離**: スクリプトは独立したプロセスで実行
- **タイムアウト**: 実行時間の制限
- **リソース制限**: メモリ・CPU使用量の制限

### 4.3 通信セキュリティ
- **CORS**: Cross-Origin Resource Sharing設定
- **WebSocket検証**: 接続元の検証
- **エラーハンドリング**: 機密情報の漏洩防止

## 5. 拡張性設計

### 5.1 新機能追加
- **プラグイン方式**: 新しいスクリプトの追加が容易
- **設定ファイル**: 動的な設定変更対応
- **モジュール化**: 各機能の独立性を保持

### 5.2 スケーラビリティ
- **ワーカープロセス**: 並列処理対応
- **キャッシュ**: 結果のキャッシュ機能
- **ロードバランシング**: 複数インスタンス対応

## 6. 運用設計

### 6.1 監視・ログ
- **実行ログ**: 各スクリプトの実行履歴
- **エラーログ**: 詳細なエラー情報
- **パフォーマンス**: 実行時間の監視

### 6.2 設定管理
- **環境変数**: `.env`ファイルでの設定管理
- **設定検証**: 起動時の設定値チェック
- **デフォルト値**: 安全なデフォルト設定

## 7. 今後の拡張計画

### 7.1 機能拡張
- **バッチ処理**: 複数操作の一括実行
- **スケジューラー**: 定期実行機能
- **通知システム**: 実行結果の通知

### 7.2 UI/UX改善
- **ダークモード**: テーマ切り替え
- **モバイル対応**: レスポンシブデザイン
- **国際化**: 多言語対応

### 7.3 セキュリティ強化
- **認証システム**: ユーザー認証の実装
- **API Rate Limiting**: アクセス制限
- **暗号化**: 通信の暗号化